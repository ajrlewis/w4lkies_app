{% extends "dashboard/base.html" %}

{% set active_page = "booking" %}
{% if booking %}
  {% set content_header = "Booking " + booking.id | string %}
  {% set form_action = url_for('booking_bp.update', booking_id=booking.id) %}
  {% set form_submit = "Update" %}
{% else %}
  {% set content_header = "Bookings" %}
  {% set form_action = url_for('booking_bp.add') %}
  {% set form_submit = "Add" %}
{% endif %}

{% block content %}
<div class="dashboard">

  <div class="container">
    <br>
    <div class="row">
      <div class="twelve columns">
        <h1>{{ content_header }}</h1>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Only add or update if user is admin -->
    {% if current_user.is_admin %}
      <form action="{{ form_action }}" method="POST">
        {{ form.csrf_token }}
        <div class="row">
          <div class="twelve columns">
            {{ form.user_id.label() }}
            {{ form.user_id(class_="u-full-width") }}
          </div>
        </div>
        <div class="row">
          <div class="six columns">
            {{ form.customer_id.label() }}
            {{ form.customer_id(class_="u-full-width") }}
          </div>
          <div class="six columns">
            {{ form.service_id.label() }}
            {{ form.service_id(class_="u-full-width") }}
          </div>
        </div>
        <div class="row">
          <div class="six columns">
            {{ form.date.label() }}
            {{ form.date(class_="u-full-width") }}
          </div>
          <div class="six columns">
            {{ form.time.label() }}
            {{ form.time(class_="u-full-width") }}
          </div>
        </div>
        <div class="row">
          <div class="twelve columns">
            <button type="submit">
              {{ form_submit }}
            </button>
          </div>
        </div>
      </form>
      {% if booking %}
        <button onclick="window.location.href='{{ url_for('booking_bp.get') }}'">Cancel</button>
      {% endif %}
    {% endif %}

    {% if upcoming_bookings or previous_bookings %}
      <!-- Add space -->
      {% if current_user.is_admin %} 
        <br>
      {% endif %}
  </div>
</div>

<div class="team">

  <br>
  <button id="upcoming-radio" type="radio">Upcoming</button>
  &nbsp;
  <button id="previous-radio" type="radio">Previous</button>
  <br>
  <br>

  <!-- Show upcoming bookings -->
  <div class="container" id="upcoming-bookings">
    {% if upcoming_bookings | length == 0 %}
      <h2>No Upcoming Bookings</h2>
    {% endif %}
    {% for (date, day_of_week), bookings in upcoming_bookings.items() %}
      {% set bookings_sum = bookings | sum(attribute='service.price') %}
      <h2>{{ day_of_week | upper }} {{ date }}</h2>
      <h3>
        {{ bookings | length }} bookings 
        {% if current_user.is_admin %}
          - {{ "Â£%0.2f" | format(bookings_sum | float) }}
        {% endif %}
      </h3>
      <br>
      {% for booking in bookings %}
        <div class="entity">
          <h4>{{ booking.time.strftime("%I:%M %p") }} - {{ booking.user.name | safe }} </h4>
          <h5>{{ booking.customer.dogs[0].name | safe }} - {{ booking.service.name | safe }}</h5>
          {% if current_user.is_admin %}
            <div class="row">
              <div class="six columns">
                <button onclick="window.location.href='{{ url_for('booking_bp.get', booking_id=booking.id) }}'" type="submit">
                    Update
                </button>
              </div>
              <div class="six columns">
                <form
                  action="{{ url_for('booking_bp.delete', booking_id=booking.id) }}"
                  method="POST"
                  onsubmit="return confirm('Are you sure you want to delete this booking?');"
                style="margin: 0;"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button type="submit">Delete</button>
                </form>
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
    </div>

    <!-- Previous bookings -->
    <div class="container" id="previous-bookings" style="display: none;">
      {% for booking in previous_bookings %}
        <h2>Booking {{ booking.id }}</h2>
        <h3>{{ booking.date }} {{ booking.time.strftime("%I:%M %p") }}</h3>
        <h4>{{ booking.user.name | safe }} - {{ booking.customer.dogs[0].name | safe }}</h4>
        <h5>{{ booking.service.name | safe }}</h5>
        <div class="row">
          <div class="six columns">
            <button
            onclick="window.location.href='{{ url_for('booking_bp.get', booking_id=booking.id) }}'"
            type="submit"
          >
            Update
            </button>
          </div>
          <div class="six columns">
            <form
              action="{{ url_for('booking_bp.delete', booking_id=booking.id) }}"
              method="POST"
              onsubmit="return confirm('Are you sure you want to delete this booking?');"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
              <button type="submit">
                Delete
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
{% endif %}
<br>
<br>
<br>
</div>
{% endblock %}

{% block scripts %}
  <script>
    const upcomingDiv = document.getElementById('upcoming-bookings');
    const previousDiv = document.getElementById('previous-bookings');
    upcomingRadio.addEventListener('click', () => {
      upcomingDiv.style.display = 'block';
      previousDiv.style.display = 'none';
    });
    previousRadio.addEventListener('click', () => {
      upcomingDiv.style.display = 'none';
      previousDiv.style.display = 'block';
    });
  </script>
{% endblock %}
